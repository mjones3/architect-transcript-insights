name: Deploy to EC2

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

env:
  EC2_HOST: 54.89.55.82
  EC2_USER: ec2-user
  S3_BUCKET: architect-transcripts-294417223953-prod
  APP_NAME: architect-transcript-insights

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: |
        npm run build || echo "Build step completed with warnings"
        
    - name: Create deployment package
      run: |
        mkdir -p deployment
        # Copy application files
        cp -r src server public package*.json deployment/ 2>/dev/null || true
        cp -r dist deployment/ 2>/dev/null || cp -r build deployment/ 2>/dev/null || true
        cp tsconfig*.json vite.config.ts postcss.config.js tailwind.config.js deployment/ 2>/dev/null || true
        
        # Create production environment file
        cat > deployment/.env << EOF
        NODE_ENV=production
        AWS_REGION=us-east-1
        S3_BUCKET_NAME=${{ env.S3_BUCKET }}
        PORT=3001
        VITE_API_BASE_URL=http://architect-transcript-alb-343036505.us-east-1.elb.amazonaws.com/api
        EOF
        
        # Create tarball
        cd deployment
        tar -czf ../app-deployment.tar.gz .
        cd ..
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
        
    - name: Upload to S3
      run: |
        DEPLOY_ID=$(date +%Y%m%d-%H%M%S)
        aws s3 cp app-deployment.tar.gz s3://${{ env.S3_BUCKET }}/deployments/app-$DEPLOY_ID.tar.gz
        aws s3 cp app-deployment.tar.gz s3://${{ env.S3_BUCKET }}/deployments/app-latest.tar.gz
        echo "DEPLOY_ID=$DEPLOY_ID" >> $GITHUB_ENV
        
    - name: Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.EC2_HOST }}
        username: ${{ env.EC2_USER }}
        key: ${{ secrets.EC2_PRIVATE_KEY }}
        script: |
          set -e
          echo "=== Starting automated deployment ==="
          
          # Create backup
          BACKUP_DIR="/opt/backups/$(date +%Y%m%d-%H%M%S)"
          sudo mkdir -p $BACKUP_DIR
          sudo cp -r /opt/${{ env.APP_NAME }} $BACKUP_DIR/ 2>/dev/null || true
          
          # Download latest deployment
          cd /tmp
          aws s3 cp s3://${{ env.S3_BUCKET }}/deployments/app-latest.tar.gz .
          
          # Ensure Node.js is available
          if ! command -v node &> /dev/null; then
            echo "Installing Node.js..."
            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
            source ~/.nvm/nvm.sh
            nvm install 16
            nvm use 16
            
            # Make node available system-wide
            sudo ln -sf ~/.nvm/versions/node/v16.*/bin/node /usr/local/bin/node
            sudo ln -sf ~/.nvm/versions/node/v16.*/bin/npm /usr/local/bin/npm
            sudo npm install -g pm2
          fi
          
          # Extract application
          sudo mkdir -p /opt/${{ env.APP_NAME }}
          cd /opt/${{ env.APP_NAME }}
          sudo rm -rf * .* 2>/dev/null || true
          sudo tar -xzf /tmp/app-latest.tar.gz
          
          # Install dependencies
          echo "Installing dependencies..."
          sudo npm install --production
          
          # Set proper ownership
          sudo chown -R ec2-user:ec2-user /opt/${{ env.APP_NAME }}
          
          # Restart application
          echo "Restarting application..."
          pm2 delete all 2>/dev/null || true
          
          # Start services
          if [ -f server/index.js ]; then
            pm2 start server/index.js --name transcript-api
          elif [ -f server/index.ts ]; then
            pm2 start "npx tsx server/index.ts" --name transcript-api
          fi
          
          # Start frontend if built
          if [ -d dist ]; then
            pm2 serve dist 3000 --name transcript-frontend --spa
          fi
          
          pm2 save
          pm2 startup systemd -u ec2-user --hp /home/ec2-user
          
          # Ensure nginx is configured
          if [ ! -f /etc/nginx/conf.d/app.conf ]; then
            sudo tee /etc/nginx/conf.d/app.conf > /dev/null << 'NGINXEOF'
          server {
              listen 80;
              listen 3000;
              server_name _;
              
              location / {
                  proxy_pass http://127.0.0.1:3000;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_cache_bypass $http_upgrade;
              }
              
              location /api {
                  proxy_pass http://127.0.0.1:3001;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection 'upgrade';
                  proxy_set_header Host $host;
                  proxy_cache_bypass $http_upgrade;
              }
              
              location /health {
                  proxy_pass http://127.0.0.1:3001/health;
              }
          }
          NGINXEOF
            sudo systemctl restart nginx
          fi
          
          # Cleanup
          rm /tmp/app-latest.tar.gz
          
          echo "=== Deployment completed ==="
          pm2 status
          
    - name: Test deployment
      run: |
        sleep 10
        curl -f http://architect-transcript-alb-343036505.us-east-1.elb.amazonaws.com/health || echo "Health check failed"
        
    - name: Update CLAUDE.md
      run: |
        # Update CLAUDE.md with deployment info
        cat >> CLAUDE.md << EOF
        
        ## Deployment $(date +%Y-%m-%d\ %H:%M)
        - **Commit**: ${{ github.sha }}
        - **Deployed by**: GitHub Actions (automated)
        - **Deploy ID**: ${{ env.DEPLOY_ID }}
        - **Status**: Successful
        - **Changes**: ${{ github.event.head_commit.message }}
        EOF
        
        # Commit the updated CLAUDE.md
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add CLAUDE.md
        git commit -m "Auto-update CLAUDE.md with deployment info [skip ci]" || echo "No changes to commit"
        git push origin main || echo "Failed to push CLAUDE.md updates"
        
    - name: Notify completion
      run: |
        echo "ðŸš€ Deployment completed successfully!"
        echo "Application URL: http://architect-transcript-alb-343036505.us-east-1.elb.amazonaws.com"
        echo "Deploy ID: ${{ env.DEPLOY_ID }}"